<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Productivity Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/gridstack@10.0.1/dist/gridstack.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gridstack@10.0.1/dist/gridstack-all.js"></script>
</head>
<body>

  <div class="grid-stack">
    <div class="grid-stack-item" gs-id="todo" gs-x="0" gs-y="0" gs-w="4" gs-h="4">
      <div class="grid-stack-item-content container todo-section">
        <h2 class="drag-handle">My Tasks</h2>
        <div class="pulley-container">
          <table id="list">
            <thead><tr><th>Task</th><th>Priority</th><th>Done</th><th>Time</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <button onclick="location.href='save.html'" style="margin-top:10px;">+ Add Task</button>
      </div>
    </div>

    <div class="grid-stack-item" gs-id="chart" gs-x="4" gs-y="0" gs-w="4" gs-h="4">
      <div class="grid-stack-item-content container chart-section">
        <h3 class="drag-handle">Priority Stats</h3>
        <canvas id="priorityChart"></canvas>
      </div>
    </div>

    <div class="grid-stack-item" gs-id="clock" gs-x="8" gs-y="0" gs-w="3" gs-h="4">
      <div class="grid-stack-item-content container clock-section">
        <h3 class="drag-handle">Clock</h3>
        <div id="digital-clock">00:00:00</div>
        <div class="analog-face">
          <div class="hand hour" id="hour-hand"></div>
          <div class="hand min" id="min-hand"></div>
          <div class="hand sec" id="sec-hand"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';
    const user = localStorage.getItem("username");
    if (!user) location.href = "login.html";

    // 1. Initialize GridStack
    const grid = GridStack.init({
      cellHeight: 100,
      margin: 10,
      handle: '.drag-handle', // Drag only by the header
      resizable: { handles: 'se' } // Resize from bottom-right
    });

    // 2. Load Layout from Supabase
    async function loadLayout() {
      const { data } = await supabase.from('users').select('dashboard_layout').eq('username', user).single();
      if (data?.dashboard_layout) {
        grid.load(data.dashboard_layout);
      }
      load(); // Load your tasks/chart/clock data
    }

    // 3. Save Layout when windows stop moving/resizing
    grid.on('change', async () => {
      const layout = grid.save();
      await supabase.from('users').update({ dashboard_layout: layout }).eq('username', user);
    });

    // ... Keep your existing load(), updateChart(), and runClock() functions here ...
    // Note: Use 'loadLayout()' instead of 'load()' at the very end of your script.

    loadLayout();
    setInterval(runClock, 1000);
  </script>
</body>
</html>
