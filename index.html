<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Tasks</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h2 id="welcome">My Tasks</h2>
    <table id="taskTable">
      <thead>
        <tr><th>Task</th><th>Priority</th><th>Done</th><th>Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="location.href='save.html'">+ Add New Task</button>
    <button class="secondary" onclick="localStorage.clear(); location.href='login.html'">Logout</button>
  </div>

  <div id="deleteModal" class="modal-overlay">
    <div class="modal">
      <h3>Are you sure?</h3>
      <p>This action cannot be undone.</p>
      <button id="confirmDelete" style="background: red;">Delete</button>
      <button onclick="closeModal()" class="secondary">Cancel</button>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';
    const user = localStorage.getItem("username");
    if (!user) location.href = "login.html";
    
    let taskToDelete = null;

    async function loadTasks() {
      const { data } = await supabase.from('todolist').select('*').eq('username', user);
      const tbody = document.querySelector("#taskTable tbody");
      tbody.innerHTML = "";

      data?.forEach(task => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${task.uzd}</td>
          <td>${task.svarigums}</td>
          <td><input type="checkbox" ${task.pabeigts ? 'checked' : ''}></td>
          <td><button class="delete-btn" style="width:auto; padding:5px 10px; background:red;">âœ–</button></td>
        `;

        // Handle Checkbox
        const cb = tr.querySelector("input");
        cb.onchange = async () => await supabase.from("todolist").update({ pabeigts: cb.checked }).eq("id", task.id);

        // Handle Delete Trigger
        tr.querySelector(".delete-btn").onclick = () => {
          taskToDelete = task.id;
          document.getElementById("deleteModal").style.display = "flex";
        };

        tbody.appendChild(tr);
      });
    }

    // Modal Confirmation Logic
    document.getElementById("confirmDelete").onclick = async () => {
      if (taskToDelete) {
        await supabase.from("todolist").delete().eq("id", taskToDelete);
        closeModal();
        loadTasks();
      }
    };

    window.closeModal = () => {
      document.getElementById("deleteModal").style.display = "none";
      taskToDelete = null;
    };

    loadTasks();
  </script>
</body>
</html>
