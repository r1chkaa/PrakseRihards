<script type="module">
import { supabase } from "./supabase.js";

const todoInput = document.getElementById("todoInput");
const addBtn = document.getElementById("addBtn");
const todoList = document.getElementById("todoList");
const searchInput = document.getElementById("searchInput");

let todos = [];

/* LOAD TODOS */
async function loadTodos() {
  const { data, error } = await supabase
    .from("todos")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    console.error(error);
    return;
  }

  todos = data;
  renderTodos();
}

/* ADD TODO */
addBtn.addEventListener("click", async () => {
  const title = todoInput.value.trim();
  if (!title) return;

  const { error } = await supabase
    .from("todos")
    .insert({ title });

  if (error) {
    console.error(error);
    return;
  }

  todoInput.value = "";
  loadTodos();
});

/* DELETE TODO */
async function deleteTodo(id) {
  await supabase.from("todos").delete().eq("id", id);
  loadTodos();
}

/* RENDER + SEARCH */
function renderTodos() {
  const search = searchInput.value.toLowerCase();
  todoList.innerHTML = "";

  todos.forEach(todo => {
    if (todo.title.toLowerCase().includes(search)) {
      const li = document.createElement("li");
      li.innerHTML = `
        <span>${todo.title}</span>
        <button class="delete">X</button>
      `;

      li.querySelector("button").onclick = () => deleteTodo(todo.id);
      todoList.appendChild(li);
    }
  });
}

searchInput.addEventListener("input", renderTodos);

/* INIT */
loadTodos();
</script>
