<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Productivity Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="main-layout">
    
    <div class="container todo-section">
      <h2>My Tasks</h2>
      <div class="pulley-container"> <table id="list">
          <thead>
            <tr>
              <th>Task</th>
              <th>Priority</th>
              <th>Done</th>
              <th>Time</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <button onclick="location.href='save.html'" style="margin-top:15px;">+ Add Task</button>
      <button onclick="localStorage.clear(); location.href='login.html';" class="secondary" style="margin-top:10px;">Logout</button>
    </div>

    <div class="container chart-section">
      <h3>Priority Stats</h3>
      <canvas id="priorityChart"></canvas>
    </div>

    <div class="container clock-section">
      <div id="digital-clock">00:00:00</div>
      <div class="analog-face">
        <div class="hand hour" id="hour-hand"></div>
        <div class="hand min" id="min-hand"></div>
        <div class="hand sec" id="sec-hand"></div>
      </div>
    </div>

  </div>

  <div id="deleteModal" class="modal-overlay">
    <div class="modal">
      <h3>Delete Task?</h3>
      <p>This cannot be undone.</p>
      <div style="display:flex; gap:10px; justify-content:center;">
        <button id="confirmBtn" style="background:red;">Delete</button>
        <button onclick="closeModal()" class="secondary">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';
    const user = localStorage.getItem("username");
    if (!user) location.href = "login.html";

    let taskToDeleteId = null;
    let myChart = null;

    // "Time Ago" Logic for your Time cell
    function getTimeAgo(dateString) {
      const now = new Date();
      const past = new Date(dateString);
      const diffInSecs = Math.floor((now - past) / 1000);

      if (diffInSecs < 60) return "now";
      const mins = Math.floor(diffInSecs / 60);
      if (mins < 60) return `${mins} min ago`;
      const hours = Math.floor(mins / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      if (days < 7) return `${days}d ago`;
      const weeks = Math.floor(days / 7);
      if (weeks < 4) return `${weeks}w ago`;
      const months = Math.floor(days / 30);
      if (months < 12) return `${months}m ago`;
      return `${Math.floor(days / 365)}y ago`;
    }

    async function load() {
      const { data } = await supabase.from('todolist').select('*').eq('username', user).order('created_at', { ascending: false });
      const tbody = document.querySelector("#list tbody");
      tbody.innerHTML = "";
      
      const counts = { Urgent: 0, "This week": 0, "This month": 0, Anytime: 0 };

      data?.forEach(t => {
        // Count for the diagram
        if (counts.hasOwnProperty(t.svarigums)) counts[t.svarigums]++;
        
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${t.uzd}</td>
          <td>${t.svarigums}</td>
          <td><input type="checkbox" ${t.pabeigts ? 'checked' : ''} onchange="toggleDone('${t.id}', this.checked)"></td>
          <td style="font-size:0.8em; opacity:0.8;">${getTimeAgo(t.created_at)}</td>
          <td><button class="del-trigger" style="width:auto; padding:5px 10px; background:red;">âœ–</button></td>
        `;

        tr.querySelector(".del-trigger").onclick = () => {
          taskToDeleteId = t.id;
          document.getElementById("deleteModal").style.display = "flex";
        };
        tbody.appendChild(tr);
      });

      updateChart(counts);
    }

    window.toggleDone = async (id, val) => {
      await supabase.from("todolist").update({ pabeigts: val }).eq("id", id);
      load();
    };

    function updateChart(counts) {
      const ctx = document.getElementById('priorityChart').getContext('2d');
      if (myChart) myChart.destroy();
      myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Urgent', 'This week', 'This month', 'Anytime'],
          datasets: [{
            data: [counts.Urgent, counts["This week"], counts["This month"], counts.Anytime],
            backgroundColor: ['#ff4d4d', '#ff944d', '#4db8ff', '#4dff88']
          }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    }

    // Working Clock Logic
    function runClock() {
      const now = new Date();
      document.getElementById('digital-clock').innerText = now.toLocaleTimeString();
      
      const s = now.getSeconds() * 6;
      const m = now.getMinutes() * 6;
      const h = (now.getHours() % 12) * 30 + (m / 12);

      document.getElementById('sec-hand').style.transform = `rotate(${s}deg)`;
      document.getElementById('min-hand').style.transform = `rotate(${m}deg)`;
      document.getElementById('hour-hand').style.transform = `rotate(${h}deg)`;
    }

    document.getElementById("confirmBtn").onclick = async () => {
      await supabase.from("todolist").delete().eq("id", taskToDeleteId);
      closeModal();
      load();
    };

    window.closeModal = () => document.getElementById("deleteModal").style.display = "none";

    setInterval(runClock, 1000);
    load();
  </script>
</body>
</html>
