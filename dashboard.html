<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/gridstack@10.0.1/dist/gridstack.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gridstack@10.0.1/dist/gridstack-all.js"></script>
</head>
<body>

  <button class="reset-btn" onclick="hardReset()">↺ Reset Layout</button>

  <div class="grid-stack">
    <div class="grid-stack-item" gs-id="todo" gs-x="0" gs-y="0" gs-w="30" gs-h="15">
      <div class="grid-stack-item-content container todo-section">
        <h2 class="drag-handle">Tasks</h2>
        <div class="pulley-container"><table id="list"><tbody></tbody></table></div>
        <button onclick="location.href='save.html'">+ Add</button>
      </div>
    </div>

    <div class="grid-stack-item" gs-id="chart" gs-x="30" gs-y="0" gs-w="40" gs-h="12">
      <div class="grid-stack-item-content container chart-section">
        <h3 class="drag-handle">Stats</h3>
        <div class="chart-wrapper"><canvas id="priorityChart"></canvas></div>
      </div>
    </div>

    <div class="grid-stack-item" gs-id="clock" gs-x="70" gs-y="0" gs-w="25" gs-h="12">
      <div class="grid-stack-item-content container clock-section">
        <h3 class="drag-handle">Clock</h3>
        <div id="digital-clock">00:00:00</div>
        <div class="analog-face">
          <div class="hand hour" id="hour-hand"></div>
          <div class="hand min" id="min-hand"></div>
          <div class="hand sec" id="sec-hand"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';
    const user = localStorage.getItem("username");
    
    // Grid Setup
    const grid = GridStack.init({
      column: 100,
      cellHeight: '40px',
      margin: 10,
      disableOneColumnMode: true, // STOP SQUISHING
      float: true,
      handle: '.drag-handle',
      resizable: { handles: 'se' }
    });

    // Hard Reset Logic
    window.hardReset = async () => {
      if(confirm("This will force the windows to their original positions. Proceed?")) {
        await supabase.from('users').update({ dashboard_layout: null }).eq('username', user);
        window.location.reload();
      }
    };

    grid.on('change', async () => {
      const layout = grid.save();
      await supabase.from('users').update({ dashboard_layout: layout }).eq('username', user);
    });

    async function init() {
      const { data } = await supabase.from('users').select('dashboard_layout').eq('username', user).single();
      if (data?.dashboard_layout) {
        grid.load(data.dashboard_layout);
      }
      loadTasks();
    }

    async function loadTasks() {
      const { data } = await supabase.from('todolist').select('*').eq('username', user);
      const tbody = document.querySelector("#list tbody");
      tbody.innerHTML = "";
      let counts = { Urgent: 0, "This week": 0, "This month": 0, Anytime: 0 };
      
      data?.forEach(t => {
        if(counts[t.svarigums] !== undefined) counts[t.svarigums]++;
        tbody.innerHTML += `<tr><td>${t.uzd}</td><td>${t.svarigums}</td><td><button onclick="delTask('${t.id}')">✖</button></td></tr>`;
      });
      updateChart(counts);
    }

    window.delTask = async (id) => {
      await supabase.from('todolist').delete().eq('id', id);
      loadTasks();
    };

    function updateChart(counts) {
      const ctx = document.getElementById('priorityChart');
      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(counts),
          datasets: [{ data: Object.values(counts), backgroundColor: '#ff4d4d' }]
        },
        options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: 'white' } } } }
      });
    }

    function runClock() {
      const now = new Date();
      document.getElementById('digital-clock').innerText = now.toLocaleTimeString();
      const s = now.getSeconds() * 6, m = now.getMinutes() * 6, h = (now.getHours() % 12) * 30;
      document.getElementById('sec-hand').style.transform = `rotate(${s}deg)`;
      document.getElementById('min-hand').style.transform = `rotate(${m}deg)`;
      document.getElementById('hour-hand').style.transform = `rotate(${h}deg)`;
    }

    setInterval(runClock, 1000);
    init();
  </script>
</body>
</html>
