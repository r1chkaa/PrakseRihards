<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Personal Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <div class="controls">
    <div id="win-manager"></div>
    <button class="ctrl-btn" onclick="toggleManager()">ğŸ“ Windows</button>
    <button class="ctrl-btn" onclick="resetLayout()">â†º Reset</button>
  </div>

  <div id="dashboard-canvas">
    <div id="win-tasks" class="window" style="top:40px; left:40px; width:320px; height:400px;">
      <div class="window-header"><span>ALL TASKS</span><button class="close-btn" onclick="closeWin('win-tasks')">Ã—</button></div>
      <div class="window-content"><div style="flex:1; overflow-y:auto;"><table id="list-all"><tbody></tbody></table></div><button onclick="location.href='save.html'">+ Add Task</button></div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-quotes" class="window" style="top:630px; left:380px; width:640px; height:140px;">
      <div class="window-header"><span>ğŸ’­ INSPIRATION</span><button class="close-btn" onclick="closeWin('win-quotes')">Ã—</button></div>
      <div class="window-content">
        <div class="quote-container">
            <div id="quote-display">Loading...</div>
            <div id="author-display"></div>
        </div>
      </div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-stats" class="window" style="top:40px; left:380px; width:380px; height:300px;"><div class="window-header"><span>STATS</span><button class="close-btn">Ã—</button></div><div class="window-content"><canvas id="priorityChart"></canvas></div><div class="resize-handle"></div></div>
    <div id="win-clock" class="window" style="top:360px; left:380px; width:240px; height:300px;"><div class="window-header"><span>CLOCK</span><button class="close-btn">Ã—</button></div><div class="window-content"><div id="digital-clock" style="text-align:center; font-weight:bold;">00:00:00</div><div class="analog-face" id="face"><div class="hand hour" style="width:4px; height:25%"></div><div class="hand min" style="width:2px; height:35%"></div><div class="hand sec" id="sec-hand"></div></div></div><div class="resize-handle"></div></div>
    <div id="win-urgent" class="window category-win" style="top:40px; left:780px; width:240px; height:280px;"><div class="window-header"><span>ğŸš¨ URGENT</span></div><div class="window-content"><table><tbody id="list-urgent"></tbody></table></div><div class="resize-handle"></div></div>
    <div id="win-week" class="window category-win" style="top:340px; left:780px; width:240px; height:280px;"><div class="window-header"><span>ğŸ“… WEEKLY</span></div><div class="window-content"><table><tbody id="list-week"></tbody></table></div><div class="resize-handle"></div></div>
    <div id="win-month" class="window category-win" style="top:40px; left:1040px; width:240px; height:280px;"><div class="window-header"><span>ğŸŒ™ MONTHLY</span></div><div class="window-content"><table><tbody id="list-month"></tbody></table></div><div class="resize-handle"></div></div>
    <div id="win-anytime" class="window category-win" style="top:340px; left:1040px; width:240px; height:280px;"><div class="window-header"><span>â˜• ANYTIME</span></div><div class="window-content"><table><tbody id="list-anytime"></tbody></table></div><div class="resize-handle"></div></div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';
    const user = localStorage.getItem("username");
    if(!user) location.href = "login.html";

    // --- QUOTE LOGIC ---
    const quotes = [
        "Helen Keller â€” â€œThe only thing worse than being blind is having sight but no vision.â€",
        "Henry David Thoreau â€” â€œGo confidently in the direction of your dreams.â€",
        "Zig Ziglar â€” â€œYou donâ€™t have to be great to start.â€",
        "George Orwell â€” â€œIn a time of deceit telling the truth is a revolutionary act.â€",
        "Napoleon Hill â€” â€œWhatever the mind can conceive and believe, it can achieve.â€",
        "Anthony Bourdain â€” â€œYour body is not a temple, itâ€™s an amusement park.â€",
        "Edith Wharton â€” â€œThere are two ways of spreading light.â€",
        "Virginia Woolf â€” â€œA woman must have money and a room of her own.â€",
        "F. Scott Fitzgerald â€” â€œSo we beat on, boats against the current.â€",
        "Mary Shelley â€” â€œBeware; for I am fearless.â€",
        "AnaÃ¯s Nin â€” â€œWe see things not as they are, but as we are.â€",
        "Neil Gaiman â€” â€œMake good art.â€",
        "J. D. Vance â€” â€œThere is no shortcut to a meaningful life.â€",
        "H. Jackson Brown Jr. â€” â€œNever deprive someone of hope.â€",
        "Bryant H. McGill â€” â€œOne of the most sincere forms of respect is listening.â€",
        "Brian Tracy â€” â€œGoals allow you to control the direction of change.â€",
        "Christopher Hitchens â€” â€œWhat can be asserted without evidence can be dismissed.â€",
        "Stephen King â€” â€œGet busy living or get busy dying.â€",
        "Henry Miller â€” â€œThe aim of life is to live.â€",
        "Joseph Campbell â€” â€œFollow your bliss.â€",
        "BrenÃ© Brown â€” â€œVulnerability is the birthplace of innovation.â€",
        "Frederick Douglass â€” â€œIf there is no struggle, there is no progress.â€",
        "Marcel Proust â€” â€œThe real voyage of discovery consists not in seeking new lands.â€",
        "Joyce Meyer â€” â€œYou cannot have a positive life with a negative mind.â€",
        "Aleksandr Solzhenitsyn â€” â€œThe line dividing good and evil cuts through the heart.â€",
        "Thomas Merton â€” â€œHappiness is not a matter of intensity but balance.â€",
        "Victor Hugo â€” â€œEven the darkest night will end.â€",
        "Gertrude Stein â€” â€œEverybody gets so much information all day long.â€",
        "George Eliot â€” â€œIt is never too late to be what you might have been.â€",
        "Aesop â€” â€œNo act of kindness is ever wasted.â€",
        "Terry Pratchett â€” â€œStories of imagination tend to upset those without one.â€",
        "H. G. Wells â€” â€œIf you fell down yesterday, stand up today.â€",
        "Corrie Ten Boom â€” â€œWorry does not empty tomorrow of sorrow.â€",
        "Marianne Williamson â€” â€œOur deepest fear is not that we are inadequate.â€",
        "Lewis Carroll â€” â€œIf you donâ€™t know where you are going, any road will do.â€",
        "Robert Kiyosaki â€” â€œItâ€™s not how much money you make.â€",
        "John Steinbeck â€” â€œAnd now that you donâ€™t have to be perfect.â€",
        "John Burroughs â€” â€œLeap and the net will appear.â€",
        "Ken Kesey â€” â€œYou donâ€™t lead by pointing and telling.â€",
        "Simon Sinek â€” â€œPeople donâ€™t buy what you do.â€",
        "Tom Robbins â€” â€œSeriousness is the only refuge of the shallow.â€",
        "Og Mandino â€” â€œI will persist until I succeed.â€",
        "Leo Buscaglia â€” â€œChange is the end result of all true learning.â€",
        "Charles Bukowski â€” â€œFind what you love and let it kill you.â€",
        "Anne Lamott â€” â€œAlmost everything will work again if you unplug it.â€",
        "Jason Reynolds â€” â€œYour story matters.â€",
        "Jane Rule â€” â€œAnger is one of the strongest passions.â€",
        "Ben Shapiro â€” â€œFacts donâ€™t care about your feelings.â€",
        "Peter Benchley â€” â€œFear is the most powerful emotion.â€",
        "Flannery Oâ€™Connor â€” â€œYou shall know the truth.â€",
        "Hans Christian Andersen â€” â€œLife itself is the most wonderful fairy tale.â€",
        "John Trudell â€” â€œWe are here to learn.â€",
        "A. A. Milne â€” â€œYou are braver than you believe.â€",
        "Sandra Cisneros â€” â€œI write for the ones who donâ€™t speak.â€",
        "Alice Walker â€” â€œThe most common way people give up power.â€",
        "Sarah Fielding â€” â€œFriendship is the strongest bond.â€",
        "James Thurber â€” â€œLet us not look back in anger.â€",
        "Pete Hegseth â€” â€œStrength is built through challenge.â€",
        "Anh Do â€” â€œNever give up on your dreams.â€",
        "Martha Beck â€” â€œIntegrity is the cure for unhappiness.â€"
    ];

    function handleQuotes() {
        const display = document.getElementById('quote-display');
        const authorDisplay = document.getElementById('author-display');
        const now = Date.now();
        const lastUpdate = localStorage.getItem('quote_timestamp') || 0;
        const interval = 5 * 60 * 1000; // 5 minutes in ms

        let currentIndex;

        if (now - lastUpdate > interval) {
            currentIndex = Math.floor(Math.random() * quotes.length);
            localStorage.setItem('quote_index', currentIndex);
            localStorage.setItem('quote_timestamp', now);
        } else {
            currentIndex = localStorage.getItem('quote_index') || 0;
        }

        const [author, text] = quotes[currentIndex].split(' â€” ');
        display.innerText = text;
        authorDisplay.innerText = author;
    }

    // --- WINDOW ENGINE ---
    let activeWin = null, isDragging = false, isResizing = false;
    let startX, startY, startW, startH, startL, startT;

    document.addEventListener('mousedown', e => {
      const win = e.target.closest('.window');
      if (!win || e.target.classList.contains('close-btn')) return;
      activeWin = win;
      document.querySelectorAll('.window').forEach(w => w.style.zIndex = 1);
      win.style.zIndex = 10;
      startX = e.clientX; startY = e.clientY;
      startL = win.offsetLeft; startT = win.offsetTop;
      startW = win.offsetWidth; startH = win.offsetHeight;
      if (e.target.classList.contains('resize-handle')) isResizing = true;
      else if (e.target.closest('.window-header')) isDragging = true;
      else activeWin = null;
    });

    window.addEventListener('mousemove', e => {
      if (!activeWin) return;
      if (isResizing) {
        activeWin.style.width = Math.max(200, startW + (e.clientX - startX)) + 'px';
        activeWin.style.height = Math.max(100, startH + (e.clientY - startY)) + 'px';
      } else if (isDragging) {
        activeWin.style.left = (startL + (e.clientX - startX)) + 'px';
        activeWin.style.top = (startT + (e.clientY - startY)) + 'px';
      }
    });

    window.addEventListener('mouseup', () => { if(activeWin) saveLayout(); activeWin = null; isDragging = false; isResizing = false; });

    window.closeWin = (id) => { document.getElementById(id).style.display = 'none'; saveLayout(); };

    window.toggleManager = () => {
      const m = document.getElementById('win-manager');
      m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
      m.innerHTML = '<b style="font-size:0.7rem; margin-bottom:5px;">Windows</b>';
      document.querySelectorAll('.window').forEach(w => {
        const btn = document.createElement('button'); btn.className = 'win-toggle';
        const name = w.querySelector('.window-header span').innerText;
        btn.innerText = (w.style.display === 'none' ? 'Show ' : 'Hide ') + name;
        btn.onclick = () => { w.style.display = (w.style.display === 'none' ? 'flex' : 'none'); toggleManager(); saveLayout(); };
        m.appendChild(btn);
      });
    };

    async function saveLayout() {
      const layout = {};
      document.querySelectorAll('.window').forEach(w => {
        layout[w.id] = { top: w.style.top, left: w.style.left, width: w.style.width, height: w.style.height, display: w.style.display };
      });
      await supabase.from('users').update({ dashboard_layout: layout }).eq('username', user);
    }

    async function init() {
      const { data } = await supabase.from('users').select('dashboard_layout').eq('username', user).single();
      if (data?.dashboard_layout) {
        Object.keys(data.dashboard_layout).forEach(id => {
          const w = document.getElementById(id);
          if (w) Object.assign(w.style, data.dashboard_layout[id]);
        });
      }
      handleQuotes();
      setInterval(handleQuotes, 30000); // Check every 30s if timer is up
      loadTasks(); // From your previous task logic
    }
    init();
  </script>
</body>
</html>
