<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personal Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <div class="controls">
    <div id="win-manager"></div>
    <button class="ctrl-btn" onclick="toggleManager()">üìÅ Folder</button>
    <button class="ctrl-btn" onclick="resetLayout()">‚Ü∫ Reset Layout</button>
  </div>

  <div id="dashboard-canvas">
    <div id="win-tasks" class="window" style="top:20px; left:20px; width:340px; height:420px;">
      <div class="window-header"><span>MY TASKS</span><button class="close-btn" onclick="closeWin('win-tasks')">√ó</button></div>
      <div class="window-content">
        <div style="flex:1; overflow-y:auto;"><table id="list-all"><tbody></tbody></table></div>
        <button onclick="location.href='save.html'" style="margin-top:10px; width:100%; padding:10px; background:#792429; color:white; border:none; border-radius:5px; cursor:pointer;">+ Add Task</button>
      </div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-stats" class="window" style="top:20px; left:380px; width:400px; height:280px;">
      <div class="window-header"><span>PRIORITY STATS</span><button class="close-btn" onclick="closeWin('win-stats')">√ó</button></div>
      <div class="window-content"><canvas id="priorityChart"></canvas></div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-clock" class="window" style="top:320px; left:380px; width:220px; height:280px;">
      <div class="window-header"><span>CLOCK</span><button class="close-btn" onclick="closeWin('win-clock')">√ó</button></div>
      <div class="window-content">
        <div id="digital-clock" style="text-align:center; font-weight:bold; margin-bottom:10px; font-size:1.1rem;">00:00:00</div>
        <div class="analog-face" style="width:110px; height:110px; border:2px solid white; border-radius:50%; position:relative; margin:auto;">
          <div class="hand hour" id="hour-hand"></div>
          <div class="hand min" id="min-hand"></div>
          <div class="hand sec" id="sec-hand"></div>
        </div>
      </div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-quotes" class="window" style="top:620px; left:20px; width:760px; height:130px;">
      <div class="window-header"><span>üí≠ INSPIRATION</span><button class="close-btn" onclick="closeWin('win-quotes')">√ó</button></div>
      <div class="window-content" style="text-align:center; justify-content:center;">
        <div id="quote-display">Loading...</div>
        <div id="author-display" style="font-weight:bold; color:#ff4d4d; margin-top:5px;"></div>
      </div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-urgent" class="window category-win" style="top:20px; left:800px; width:250px; height:230px;">
      <div class="window-header"><span>üö® URGENT</span><button class="close-btn" onclick="closeWin('win-urgent')">√ó</button></div>
      <div class="window-content"><div style="flex:1; overflow-y:auto;"><table><tbody id="list-urgent"></tbody></table></div></div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-week" class="window category-win" style="top:270px; left:800px; width:250px; height:230px;">
      <div class="window-header"><span>üìÖ WEEKLY</span><button class="close-btn" onclick="closeWin('win-week')">√ó</button></div>
      <div class="window-content"><div style="flex:1; overflow-y:auto;"><table><tbody id="list-week"></tbody></table></div></div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-month" class="window category-win" style="top:20px; left:1070px; width:250px; height:230px;">
      <div class="window-header"><span>üåô MONTHLY</span><button class="close-btn" onclick="closeWin('win-month')">√ó</button></div>
      <div class="window-content"><div style="flex:1; overflow-y:auto;"><table><tbody id="list-month"></tbody></table></div></div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-anytime" class="window category-win" style="top:270px; left:1070px; width:250px; height:230px;">
      <div class="window-header"><span>‚òï ANYTIME</span><button class="close-btn" onclick="closeWin('win-anytime')">√ó</button></div>
      <div class="window-content"><div style="flex:1; overflow-y:auto;"><table><tbody id="list-anytime"></tbody></table></div></div>
      <div class="resize-handle"></div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';
    const user = localStorage.getItem("username");
    if(!user) location.href = "login.html";

    // --- RESET LAYOUT ---
    window.resetLayout = async () => {
      if(confirm("Restore default layout?")) {
        await supabase.from('users').update({ dashboard_layout: null }).eq('username', user);
        location.reload();
      }
    };

    // --- QUOTES ENGINE ---
    const quotes = [
      "Helen Keller ‚Äî ‚ÄúThe only thing worse than being blind is having sight but no vision.‚Äù",
      "Henry David Thoreau ‚Äî ‚ÄúGo confidently in the direction of your dreams.‚Äù",
      "Zig Ziglar ‚Äî ‚ÄúYou don‚Äôt have to be great to start.‚Äù",
      "Napoleon Hill ‚Äî ‚ÄúWhatever the mind can conceive and believe, it can achieve.‚Äù",
      "Mary Shelley ‚Äî ‚ÄúBeware; for I am fearless.‚Äù",
      "Victor Hugo ‚Äî ‚ÄúEven the darkest night will end.‚Äù",
      "Charles Bukowski ‚Äî ‚ÄúFind what you love and let it kill you.‚Äù"
      // ... more quotes can be added here
    ];

    function handleQuotes() {
      const now = Date.now();
      const last = localStorage.getItem('quote_time') || 0;
      let idx = localStorage.getItem('quote_index');
      if (now - last > 300000 || idx === null) { // 5 minutes
        idx = Math.floor(Math.random() * quotes.length);
        localStorage.setItem('quote_index', idx);
        localStorage.setItem('quote_time', now);
      }
      const [author, text] = quotes[idx].split(' ‚Äî ');
      document.getElementById('author-display').innerText = author;
      document.getElementById('quote-display').innerText = text;
    }

    // --- TASK LOADING & CHART ---
    async function loadTasks() {
      const { data } = await supabase.from('todolist').select('*').eq('username', user);
      const lists = { 'all': '#list-all', 'Urgent': '#list-urgent', 'This week': '#list-week', 'This month': '#list-month', 'Anytime': '#list-anytime' };
      
      document.querySelectorAll('table tbody').forEach(tb => tb.innerHTML = "");
      let counts = { Urgent: 0, "This week": 0, "This month": 0, Anytime: 0 };

      data?.forEach(t => {
        const row = `<tr><td>${t.uzd}</td><td style="text-align:right"><button onclick="delTask('${t.id}')" style="background:none; border:none; color:white; cursor:pointer;">‚úñ</button></td></tr>`;
        if(document.querySelector("#list-all tbody")) document.querySelector("#list-all tbody").innerHTML += row;
        if(lists[t.svarigums]) {
          document.querySelector(lists[t.svarigums] + " tbody").innerHTML += row;
          counts[t.svarigums]++;
        }
      });
      renderChart(counts);
    }

    window.delTask = async (id) => { await supabase.from('todolist').delete().eq('id', id); loadTasks(); };

    function renderChart(counts) {
      const ctx = document.getElementById('priorityChart').getContext('2d');
      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(counts),
          datasets: [{ data: Object.values(counts), backgroundColor: '#a53239', borderColor: 'white', borderWidth: 1 }]
        },
        options: { 
          maintainAspectRatio: false, 
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { color: 'white', stepSize: 1 } }, x: { ticks: { color: 'white' } } }
        }
      });
    }

    // --- WINDOW DRAG/RESIZE (NO-STICK) ---
    let activeWin = null, isDragging = false, isResizing = false;
    let offset = {x:0, y:0}, startSize = {w:0, h:0, x:0, y:0};

    document.addEventListener('mousedown', e => {
      const win = e.target.closest('.window');
      if (!win || e.target.classList.contains('close-btn')) return;
      activeWin = win;
      document.querySelectorAll('.window').forEach(w => w.style.zIndex = 1);
      win.style.zIndex = 10;
      if (e.target.classList.contains('resize-handle')) {
        isResizing = true;
        startSize = { w: win.offsetWidth, h: win.offsetHeight, x: e.clientX, y: e.clientY };
      } else if (e.target.closest('.window-header')) {
        isDragging = true;
        offset = { x: e.clientX - win.offsetLeft, y: e.clientY - win.offsetTop };
      }
    });

    window.addEventListener('mousemove', e => {
      if (!activeWin) return;
      if (isDragging) {
        activeWin.style.left = (e.clientX - offset.x) + 'px';
        activeWin.style.top = (e.clientY - offset.y) + 'px';
      } else if (isResizing) {
        activeWin.style.width = (startSize.w + (e.clientX - startSize.x)) + 'px';
        activeWin.style.height = (startSize.h + (e.clientY - startSize.y)) + 'px';
      }
    });

    window.addEventListener('mouseup', () => { if(activeWin) saveLayout(); activeWin = null; isDragging = false; isResizing = false; });

    async function saveLayout() {
      const layout = {};
      document.querySelectorAll('.window').forEach(w => {
        layout[w.id] = { top: w.style.top, left: w.style.left, width: w.style.width, height: w.style.height, display: w.style.display };
      });
      await supabase.from('users').update({ dashboard_layout: layout }).eq('username', user);
    }

    window.closeWin = (id) => { document.getElementById(id).style.display = 'none'; saveLayout(); };

    window.toggleManager = () => {
      const m = document.getElementById('win-manager');
      m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
      m.innerHTML = '<b style="font-size:0.8rem; margin-bottom:5px;">Windows</b>';
      document.querySelectorAll('.window').forEach(w => {
        const btn = document.createElement('button');
        btn.className = 'win-toggle';
        btn.innerText = (w.style.display === 'none' ? 'Show ' : 'Hide ') + w.querySelector('.window-header span').innerText;
        btn.onclick = () => { w.style.display = (w.style.display === 'none' ? 'flex' : 'none'); saveLayout(); toggleManager(); };
        m.appendChild(btn);
      });
    };

    function updateClock() {
      const now = new Date();
      document.getElementById('digital-clock').innerText = now.toLocaleTimeString();
      const s = now.getSeconds()*6, m = now.getMinutes()*6, h = (now.getHours()%12)*30 + (m/12);
      document.getElementById('sec-hand').style.transform = `rotate(${s}deg)`;
      document.getElementById('min-hand').style.transform = `rotate(${m}deg)`;
      document.getElementById('hour-hand').style.transform = `rotate(${h}deg)`;
    }

    async function init() {
      const { data } = await supabase.from('users').select('dashboard_layout').eq('username', user).single();
      if (data?.dashboard_layout) {
        Object.keys(data.dashboard_layout).forEach(id => {
          const w = document.getElementById(id);
          if (w) Object.assign(w.style, data.dashboard_layout[id]);
        });
      }
      loadTasks();
      handleQuotes();
      setInterval(updateClock, 1000);
      setInterval(handleQuotes, 30000);
    }
    init();
  </script>
</body>
</html>
