<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Personal Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <div class="controls">
    <div id="win-manager"></div>
    <button class="ctrl-btn" onclick="toggleManager()">üìÅ Windows</button>
    <button class="ctrl-btn" onclick="resetLayout()">‚Ü∫ Reset</button>
    <button class="ctrl-btn" onclick="localStorage.clear(); location.href='login.html'">Logout</button>
  </div>

  <div id="dashboard-canvas">
    <div id="win-tasks" class="window" style="top:40px; left:40px; width:340px; height:450px;">
      <div class="window-header"><span>ALL TASKS</span><button class="close-btn" onclick="closeWin('win-tasks')">√ó</button></div>
      <div class="window-content">
        <div style="flex:1; overflow-y:auto;"><table id="list-all"><tbody></tbody></table></div>
        <button onclick="location.href='save.html'">+ Add Task</button>
      </div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-stats" class="window" style="top:40px; left:400px; width:380px; height:300px;">
      <div class="window-header"><span>STATS</span><button class="close-btn" onclick="closeWin('win-stats')">√ó</button></div>
      <div class="window-content"><canvas id="priorityChart"></canvas></div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-clock" class="window" style="top:360px; left:400px; width:240px; height:300px;">
      <div class="window-header"><span>CLOCK</span><button class="close-btn" onclick="closeWin('win-clock')">√ó</button></div>
      <div class="window-content">
        <div id="digital-clock" style="text-align:center; font-weight:bold; margin-bottom:10px;">00:00:00</div>
        <div class="analog-face" id="face">
          <div class="hand hour" id="hour-hand" style="width:4px; height:25%"></div>
          <div class="hand min" id="min-hand" style="width:2px; height:35%"></div>
          <div class="hand sec" id="sec-hand"></div>
        </div>
      </div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-urgent" class="window category-win" style="top:40px; left:800px; width:250px; height:280px;">
      <div class="window-header"><span>üö® URGENT</span><button class="close-btn" onclick="closeWin('win-urgent')">√ó</button></div>
      <div class="window-content"><div style="flex:1; overflow-y:auto;"><table id="list-urgent"><tbody></tbody></table></div></div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-week" class="window category-win" style="top:340px; left:800px; width:250px; height:280px;">
      <div class="window-header"><span>üìÖ WEEKLY</span><button class="close-btn" onclick="closeWin('win-week')">√ó</button></div>
      <div class="window-content"><div style="flex:1; overflow-y:auto;"><table id="list-week"><tbody></tbody></table></div></div>
      <div class="resize-handle"></div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';
    const user = localStorage.getItem("username");
    if(!user) location.href = 'login.html';

    // Helper: Time Ago Logic
    function timeAgo(dateString) {
      const now = new Date();
      const past = new Date(dateString);
      const diff = Math.floor((now - past) / 1000);
      if (diff < 60) return diff + "s ago";
      if (diff < 3600) return Math.floor(diff/60) + "m ago";
      if (diff < 86400) return Math.floor(diff/3600) + "h ago";
      if (diff < 2592000) return Math.floor(diff/86400) + "d ago";
      if (diff < 31536000) return Math.floor(diff/2592000) + "mo ago";
      return Math.floor(diff/31536000) + "y ago";
    }

    // --- WINDOW ENGINE (FIXED STICKING) ---
    let activeWin = null, isDragging = false, isResizing = false;
    let startX, startY, startW, startH, startLeft, startTop;

    document.addEventListener('mousedown', e => {
      const win = e.target.closest('.window');
      if (!win || e.target.classList.contains('close-btn')) return;
      activeWin = win;
      document.querySelectorAll('.window').forEach(w => w.style.zIndex = 1);
      win.style.zIndex = 10;
      startX = e.clientX; startY = e.clientY;
      startLeft = win.offsetLeft; startTop = win.offsetTop;
      startW = win.offsetWidth; startH = win.offsetHeight;
      if (e.target.classList.contains('resize-handle')) isResizing = true;
      else if (e.target.closest('.window-header')) isDragging = true;
      else activeWin = null;
    });

    window.addEventListener('mousemove', e => {
      if (!activeWin) return;
      if (isResizing) {
        activeWin.style.width = Math.max(200, startW + (e.clientX - startX)) + 'px';
        activeWin.style.height = Math.max(150, startH + (e.clientY - startY)) + 'px';
        if(window.myChart && activeWin.id === 'win-stats') window.myChart.resize();
      } else if (isDragging) {
        let x = startLeft + (e.clientX - startX);
        let y = startTop + (e.clientY - startY);
        activeWin.style.left = x + 'px'; activeWin.style.top = y + 'px';
      }
    });

    window.addEventListener('mouseup', () => { 
      if (activeWin) saveLayout();
      activeWin = null; isDragging = false; isResizing = false; 
    });

    // --- DATA HANDLING ---
    async function loadTasks() {
      const { data } = await supabase.from('todolist').select('*').eq('username', user).order('created_at', {ascending: false});
      const ids = { 'all': '#list-all', 'Urgent': '#list-urgent', 'This week': '#list-week' };
      Object.values(ids).forEach(sel => { if(document.querySelector(sel)) document.querySelector(sel + " tbody").innerHTML = ""; });
      
      let counts = { Urgent:0, "This week":0, Anytime:0 };
      data?.forEach(t => {
        const row = `<tr><td><b>${t.uzd}</b><span class="time-text">${timeAgo(t.created_at)}</span></td>
                     <td style="text-align:right"><button onclick="delTask('${t.id}')" style="background:transparent; border:none; color:white; cursor:pointer;">‚úñ</button></td></tr>`;
        document.querySelector("#list-all tbody").innerHTML += row;
        if(ids[t.svarigums]) {
          document.querySelector(ids[t.svarigums] + " tbody").innerHTML += row;
          counts[t.svarigums]++;
        }
      });
      updateChart(counts);
    }

    window.delTask = async (id) => { await supabase.from('todolist').delete().eq('id', id); loadTasks(); };

    // Clock & Layout logic... (Simplified for brevity, standard as before)
    async function init() {
      // Load layout, start clock intervals, load tasks
      loadTasks();
    }
    init();
  </script>
</body>
</html>
