<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Personal Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <div class="controls">
    <div id="win-manager"></div>
    <button class="ctrl-btn" onclick="toggleManager()">üìÅ Windows</button>
    <button class="ctrl-btn" onclick="resetLayout()">‚Ü∫ Reset</button>
  </div>

  <div id="dashboard-canvas">
    
    <div id="win-tasks" class="window" style="top:40px; left:40px; width:340px; height:500px;">
      <div class="window-header"><span>ALL TASKS</span><button class="close-btn" onclick="closeWin('win-tasks')">√ó</button></div>
      <div class="window-content">
        <select id="task-filter" onchange="loadTasks()" class="styled-select">
          <option value="All">All Categories</option>
          <option value="Personal">Personal</option>
          <option value="Work">Work</option>
          <option value="School">School</option>
          <option value="Event">Event</option>
          <option value="Holidays">Holidays</option>
          <option value="Home">Home</option>
          <option value="Shopping">Shopping</option>
        </select>
        <div style="flex:1; overflow-y:auto;"><table id="list-all"><tbody></tbody></table></div>
        <button class="action-btn" onclick="location.href='save.html'">+ Add New Task</button>
      </div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-stats" class="window" style="top:40px; left:400px; width:380px; height:300px;">
      <div class="window-header"><span>STATS</span><button class="close-btn" onclick="closeWin('win-stats')">√ó</button></div>
      <div class="window-content"><canvas id="priorityChart"></canvas></div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-clock" class="window" style="top:360px; left:400px; width:240px; height:250px;">
      <div class="window-header"><span>CLOCK</span><button class="close-btn" onclick="closeWin('win-clock')">√ó</button></div>
      <div class="window-content">
        <div id="digital-clock" style="text-align:center; font-weight:bold; margin-bottom:5px;">00:00:00</div>
        <div class="analog-face">
          <div class="hand hour" id="hour-hand"></div>
          <div class="hand min" id="min-hand"></div>
          <div class="hand sec" id="sec-hand"></div>
        </div>
      </div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-urgent" class="window category-win" style="top:40px; left:800px; width:240px; height:220px;">
        <div class="window-header"><span>üö® URGENT</span><button class="close-btn" onclick="closeWin('win-urgent')">√ó</button></div>
        <div class="window-content"><table><tbody id="list-urgent"></tbody></table></div>
        <div class="resize-handle"></div>
    </div>

    <div id="win-week" class="window category-win" style="top:280px; left:800px; width:240px; height:220px;">
        <div class="window-header"><span>üìÖ THIS WEEK</span><button class="close-btn" onclick="closeWin('win-week')">√ó</button></div>
        <div class="window-content"><table><tbody id="list-week"></tbody></table></div>
        <div class="resize-handle"></div>
    </div>

    <div id="win-month" class="window category-win" style="top:520px; left:800px; width:240px; height:220px;">
        <div class="window-header"><span>üóì THIS MONTH</span><button class="close-btn" onclick="closeWin('win-month')">√ó</button></div>
        <div class="window-content"><table><tbody id="list-month"></tbody></table></div>
        <div class="resize-handle"></div>
    </div>

    <div id="win-anytime" class="window category-win" style="top:760px; left:800px; width:240px; height:220px;">
        <div class="window-header"><span>‚òï ANYTIME</span><button class="close-btn" onclick="closeWin('win-anytime')">√ó</button></div>
        <div class="window-content"><table><tbody id="list-anytime"></tbody></table></div>
        <div class="resize-handle"></div>
    </div>

  </div>

  <script type="module">
    import { supabase } from './supabase.js';
    const user = localStorage.getItem("username");
    if(!user) location.href = "login.html";

    let activeWin = null, isDragging = false, isResizing = false;
    let startX, startY, startW, startH, startL, startT;

    document.addEventListener('mousedown', e => {
      const win = e.target.closest('.window');
      if (!win || e.target.classList.contains('close-btn')) return;
      activeWin = win;
      document.querySelectorAll('.window').forEach(w => w.style.zIndex = 1);
      win.style.zIndex = 10;
      startX = e.clientX; startY = e.clientY;
      startL = win.offsetLeft; startT = win.offsetTop;
      startW = win.offsetWidth; startH = win.offsetHeight;
      if (e.target.classList.contains('resize-handle')) isResizing = true;
      else if (e.target.closest('.window-header')) isDragging = true;
      else activeWin = null;
    });

    window.addEventListener('mousemove', e => {
      if (!activeWin) return;
      if (isResizing) {
        activeWin.style.width = Math.max(200, startW + (e.clientX - startX)) + 'px';
        activeWin.style.height = Math.max(120, startH + (e.clientY - startY)) + 'px';
      } else if (isDragging) {
        activeWin.style.left = (startL + (e.clientX - startX)) + 'px';
        activeWin.style.top = (startT + (e.clientY - startY)) + 'px';
      }
    });

    window.addEventListener('mouseup', () => { if(activeWin) saveLayout(); isDragging = isResizing = false; activeWin = null; });

    window.loadTasks = async () => {
      const filterVal = document.getElementById('task-filter').value;
      const { data } = await supabase.from('todolist').select('*').eq('username', user).order('created_at', {ascending: false});
      const ids = { 'Urgent': '#list-urgent', 'This week': '#list-week', 'This month': '#list-month', 'Anytime': '#list-anytime' };
      document.querySelectorAll('table tbody').forEach(b => b.innerHTML = "");
      let counts = { Urgent:0, "This week":0, "This month":0, "Anytime": 0 };

      data?.forEach(t => {
        const row = `<tr><td><b>${t.uzd}</b><br><span class="time-text">${t.uzdveids}</span></td><td style="text-align:right"><button onclick="delTask('${t.id}')" class="del-btn">‚úñ</button></td></tr>`;
        if (filterVal === "All" || t.uzdveids === filterVal) document.querySelector("#list-all tbody").innerHTML += row;
        if(ids[t.svarigums]) { 
          document.querySelector(ids[t.svarigums]).innerHTML += row; 
          counts[t.svarigums]++; 
        }
      });
      updateChart(counts);
    };

    window.delTask = async (id) => { await supabase.from('todolist').delete().eq('id', id); loadTasks(); };

    window.closeWin = (id) => { document.getElementById(id).style.display = 'none'; saveLayout(); renderManager(); };

    window.toggleManager = () => {
        const mgr = document.getElementById('win-manager');
        mgr.style.display = (mgr.style.display === 'flex') ? 'none' : 'flex';
        if(mgr.style.display === 'flex') renderManager();
    };

    function renderManager() {
        const mgr = document.getElementById('win-manager');
        mgr.innerHTML = '<div style="font-size:0.8rem; margin-bottom:5px; color:#ccc;">Windows:</div>';
        document.querySelectorAll('.window').forEach(w => {
            const name = w.querySelector('.window-header span').innerText;
            const isVisible = w.style.display !== 'none';
            const btn = document.createElement('button');
            btn.className = 'win-toggle';
            btn.innerHTML = (isVisible ? '‚úî ' : '‚óª ') + name;
            btn.onclick = () => { w.style.display = isVisible ? 'none' : 'flex'; saveLayout(); renderManager(); };
            mgr.appendChild(btn);
        });
    }

    window.resetLayout = async () => {
        if(!confirm("Reset layout?")) return;
        const defaults = {
            'win-tasks': {top:'40px', left:'40px', width:'340px', height:'500px', display:'flex'},
            'win-stats': {top:'40px', left:'400px', width:'380px', height:'300px', display:'flex'},
            'win-clock': {top:'360px', left:'400px', width:'240px', height:'250px', display:'flex'},
            'win-urgent': {top:'40px', left:'800px', width:'240px', height:'220px', display:'flex'},
            'win-week': {top:'280px', left:'800px', width:'240px', height:'220px', display:'flex'},
            'win-month': {top:'520px', left:'800px', width:'240px', height:'220px', display:'flex'},
            'win-anytime': {top:'760px', left:'800px', width:'240px', height:'220px', display:'flex'}
        };
        Object.keys(defaults).forEach(id => {
            const w = document.getElementById(id);
            if(w) Object.assign(w.style, defaults[id]);
        });
        await supabase.from('users').update({ dashboard_layout: defaults }).eq('username', user);
    };
    
    async function saveLayout() {
      const layout = {};
      document.querySelectorAll('.window').forEach(w => {
        layout[w.id] = { top: w.style.top, left: w.style.left, width: w.style.width, height: w.style.height, display: w.style.display };
      });
      await supabase.from('users').update({ dashboard_layout: layout }).eq('username', user);
    }

    function runClock() {
      const n = new Date(); document.getElementById('digital-clock').innerText = n.toLocaleTimeString();
      const s = n.getSeconds()*6, m = n.getMinutes()*6, h = (n.getHours()%12)*30 + (m/12);
      document.getElementById('sec-hand').style.transform = `rotate(${s}deg) translateX(-50%)`;
      document.getElementById('min-hand').style.transform = `rotate(${m}deg) translateX(-50%)`;
      document.getElementById('hour-hand').style.transform = `rotate(${h}deg) translateX(-50%)`;
    }

    function updateChart(counts) {
      const ctx = document.getElementById('priorityChart');
      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type: 'bar', 
        data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: ['#a53239', '#8a2b30', '#6e2226', '#50181c'], borderColor: 'white', borderWidth: 1 }] },
        options: { maintainAspectRatio: false, scales: { y: { ticks: { color: 'white' } }, x: { ticks: { color: 'white' } } }, plugins: { legend: { display: false } } }
      });
    }

    async function init() {
      const { data } = await supabase.from('users').select('dashboard_layout').eq('username', user).single();
      if (data?.dashboard_layout) {
        Object.keys(data.dashboard_layout).forEach(id => {
          const w = document.getElementById(id);
          if (w) Object.assign(w.style, data.dashboard_layout[id]);
        });
      }
      loadTasks(); setInterval(runClock, 1000); runClock();
    }
    init();
  </script>
</body>
</html>
