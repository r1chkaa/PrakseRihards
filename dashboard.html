<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Personal Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <div id="modal-overlay">
    <div class="confirm-box">
      <p style="margin: 0; font-weight: bold;">Delete this task?</p>
      <div class="confirm-btns">
        <button id="confirm-yes" style="background: #a53239;">YES</button>
        <button id="confirm-no" class="btn-no">NO</button>
      </div>
    </div>
  </div>

  <div class="controls">
    <div id="win-manager"></div>
    <button class="ctrl-btn" onclick="toggleManager()">üìÅ Windows</button>
    <button class="ctrl-btn" onclick="resetLayout()">‚Ü∫ Reset</button>
  </div>

  <div id="dashboard-canvas">
    <div id="win-tasks" class="window" style="top:40px; left:40px; width:320px; height:450px;">
      <div class="window-header"><span>ALL TASKS</span><button class="close-btn" onclick="closeWin('win-tasks')">√ó</button></div>
      <div class="window-content">
        
        <select id="task-filter" onchange="loadTasks()" style="color: black; background: #ffcccc; margin-bottom: 10px; padding: 5px; border-radius: 5px; width: 100%; border: 1px solid rgba(0,0,0,0.1); font-weight: bold;">
          <option value="All" style="color: black; background: #fff0f0;">All Categories</option>
          <option value="Personal" style="color: black; background: #fff0f0;">Personal</option>
          <option value="Work" style="color: black; background: #fff0f0;">Work</option>
          <option value="School" style="color: black; background: #fff0f0;">School</option>
          <option value="Event" style="color: black; background: #fff0f0;">Event</option>
          <option value="Holidays" style="color: black; background: #fff0f0;">Holidays</option>
          <option value="Home" style="color: black; background: #fff0f0;">Home</option>
          <option value="Shopping" style="color: black; background: #fff0f0;">Shopping</option>
        </select>

        <div style="flex:1; overflow-y:auto;"><table id="list-all"><tbody></tbody></table></div>
        <button onclick="location.href='save.html'">+ Add Task</button>
      </div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-stats" class="window" style="top:40px; left:380px; width:380px; height:300px;">
      <div class="window-header"><span>STATS</span><button class="close-btn" onclick="closeWin('win-stats')">√ó</button></div>
      <div class="window-content"><canvas id="priorityChart"></canvas></div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-clock" class="window" style="top:360px; left:380px; width:240px; height:250px;">
      <div class="window-header"><span>CLOCK</span><button class="close-btn" onclick="closeWin('win-clock')">√ó</button></div>
      <div class="window-content">
        <div id="digital-clock" style="text-align:center; font-weight:bold; margin-bottom:10px;">00:00:00</div>
        <div class="analog-face" style="width:100px; height:100px; border:2px solid white; border-radius:50%; position:relative; margin:auto;">
          <div class="hand hour" id="hour-hand" style="width:4px; height:25%"></div>
          <div class="hand min" id="min-hand" style="width:2px; height:35%"></div>
          <div class="hand sec" id="sec-hand"></div>
        </div>
      </div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-quotes" class="window" style="top:630px; left:380px; width:640px; height:140px;">
      <div class="window-header"><span>üí≠ INSPIRATION</span><button class="close-btn" onclick="closeWin('win-quotes')">√ó</button></div>
      <div class="window-content">
        <div id="quote-display">Loading...</div>
        <div id="author-display" style="font-weight:bold; color:#ff4d4d; margin-top:5px;"></div>
      </div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-urgent" class="window category-win" style="top:40px; left:780px; width:240px; height:280px;"><div class="window-header"><span>üö® URGENT</span><button class="close-btn" onclick="closeWin('win-urgent')">√ó</button></div><div class="window-content"><div style="flex:1; overflow-y:auto;"><table id="list-urgent"><tbody></tbody></table></div></div><div class="resize-handle"></div></div>
    <div id="win-week" class="window category-win" style="top:340px; left:780px; width:240px; height:280px;"><div class="window-header"><span>üìÖ WEEKLY</span><button class="close-btn" onclick="closeWin('win-week')">√ó</button></div><div class="window-content"><div style="flex:1; overflow-y:auto;"><table id="list-week"><tbody></tbody></table></div></div><div class="resize-handle"></div></div>
    <div id="win-month" class="window category-win" style="top:40px; left:1040px; width:240px; height:280px;"><div class="window-header"><span>üåô MONTHLY</span><button class="close-btn" onclick="closeWin('win-month')">√ó</button></div><div class="window-content"><div style="flex:1; overflow-y:auto;"><table id="list-month"><tbody></tbody></table></div></div><div class="resize-handle"></div></div>
    <div id="win-anytime" class="window category-win" style="top:340px; left:1040px; width:240px; height:280px;"><div class="window-header"><span>‚òï ANYTIME</span><button class="close-btn" onclick="closeWin('win-anytime')">√ó</button></div><div class="window-content"><div style="flex:1; overflow-y:auto;"><table id="list-anytime"><tbody></tbody></table></div></div><div class="resize-handle"></div></div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';
    const user = localStorage.getItem("username");
    if(!user) location.href = "login.html";

    const quotes = ["Helen Keller ‚Äî ‚ÄúThe only thing worse than being blind is having sight but no vision.‚Äù", "Henry David Thoreau ‚Äî ‚ÄúGo confidently in the direction of your dreams.‚Äù", "Zig Ziglar ‚Äî ‚ÄúYou don‚Äôt have to be great to start.‚Äù", "George Orwell ‚Äî ‚ÄúIn a time of deceit telling the truth is a revolutionary act.‚Äù", "Napoleon Hill ‚Äî ‚ÄúWhatever the mind can conceive and believe, it can achieve.‚Äù", "Anthony Bourdain ‚Äî ‚ÄúYour body is not a temple, it‚Äôs an amusement park.‚Äù", "Edith Wharton ‚Äî ‚ÄúThere are two ways of spreading light.‚Äù", "Virginia Woolf ‚Äî ‚ÄúA woman must have money and a room of her own.‚Äù", "F. Scott Fitzgerald ‚Äî ‚ÄúSo we beat on, boats against the current.‚Äù", "Mary Shelley ‚Äî ‚ÄúBeware; for I am fearless.‚Äù", "Ana√Øs Nin ‚Äî ‚ÄúWe see things not as they are, but as we are.‚Äù", "Neil Gaiman ‚Äî ‚ÄúMake good art.‚Äù", "J. D. Vance ‚Äî ‚ÄúThere is no shortcut to a meaningful life.‚Äù", "H. Jackson Brown Jr. ‚Äî ‚ÄúNever deprive someone of hope.‚Äù", "Bryant H. McGill ‚Äî ‚ÄúOne of the most sincere forms of respect is listening.‚Äù", "Brian Tracy ‚Äî ‚ÄúGoals allow you to control the direction of change.‚Äù", "Christopher Hitchens ‚Äî ‚ÄúWhat can be asserted without evidence can be dismissed.‚Äù", "Stephen King ‚Äî ‚ÄúGet busy living or get busy dying.‚Äù", "Henry Miller ‚Äî ‚ÄúThe aim of life is to live.‚Äù", "Joseph Campbell ‚Äî ‚ÄúFollow your bliss.‚Äù", "Bren√© Brown ‚Äî ‚ÄúVulnerability is the birthplace of innovation.‚Äù", "Frederick Douglass ‚Äî ‚ÄúIf there is no struggle, there is no progress.‚Äù", "Marcel Proust ‚Äî ‚ÄúThe real voyage of discovery consists not in seeking new lands.‚Äù", "Joyce Meyer ‚Äî ‚ÄúYou cannot have a positive life with a negative mind.‚Äù", "Aleksandr Solzhenitsyn ‚Äî ‚ÄúThe line dividing good and evil cuts through the heart.‚Äù", "Thomas Merton ‚Äî ‚ÄúHappiness is not a matter of intensity but balance.‚Äù", "Victor Hugo ‚Äî ‚ÄúEven the darkest night will end.‚Äù", "Gertrude Stein ‚Äî ‚ÄúEverybody gets so much information all day long.‚Äù", "George Eliot ‚Äî ‚ÄúIt is never too late to be what you might have been.‚Äù", "Aesop ‚Äî ‚ÄúNo act of kindness is ever wasted.‚Äù", "Terry Pratchett ‚Äî ‚ÄúStories of imagination tend to upset those without one.‚Äù", "H. G. Wells ‚Äî ‚ÄúIf you fell down yesterday, stand up today.‚Äù", "Corrie Ten Boom ‚Äî ‚ÄúWorry does not empty tomorrow of sorrow.‚Äù", "Marianne Williamson ‚Äî ‚ÄúOur deepest fear is not that we are inadequate.‚Äù", "Lewis Carroll ‚Äî ‚ÄúIf you don‚Äôt know where you are going, any road will do.‚Äù", "Robert Kiyosaki ‚Äî ‚ÄúIt‚Äôs not how much money you make.‚Äù", "John Steinbeck ‚Äî ‚ÄúAnd now that you don‚Äôt have to be perfect.‚Äù", "John Burroughs ‚Äî ‚ÄúLeap and the net will appear.‚Äù", "Ken Kesey ‚Äî ‚ÄúYou don‚Äôt lead by pointing and telling.‚Äù", "Simon Sinek ‚Äî ‚ÄúPeople don‚Äôt buy what you do.‚Äù", "Tom Robbins ‚Äî ‚ÄúSeriousness is the only refuge of the shallow.‚Äù", "Og Mandino ‚Äî ‚ÄúI will persist until I succeed.‚Äù", "Leo Buscaglia ‚Äî ‚ÄúChange is the end result of all true learning.‚Äù", "Charles Bukowski ‚Äî ‚ÄúFind what you love and let it kill you.‚Äù", "Anne Lamott ‚Äî ‚ÄúAlmost everything will work again if you unplug it.‚Äù", "Jason Reynolds ‚Äî ‚ÄúYour story matters.‚Äù", "Jane Rule ‚Äî ‚ÄúAnger is one of the strongest passions.‚Äù", "Ben Shapiro ‚Äî ‚ÄúFacts don‚Äôt care about your feelings.‚Äù", "Peter Benchley ‚Äî ‚ÄúFear is the most powerful emotion.‚Äù", "Flannery O‚ÄôConnor ‚Äî ‚ÄúYou shall know the truth.‚Äù", "Hans Christian Andersen ‚Äî ‚ÄúLife itself is the most wonderful fairy tale.‚Äù", "John Trudell ‚Äî ‚ÄúWe are here to learn.‚Äù", "A. A. Milne ‚Äî ‚ÄúYou are braver than you believe.‚Äù", "Sandra Cisneros ‚Äî ‚ÄúI write for the ones who don‚Äôt speak.‚Äù", "Alice Walker ‚Äî ‚ÄúThe most common way people give up power.‚Äù", "Sarah Fielding ‚Äî ‚ÄúFriendship is the strongest bond.‚Äù", "James Thurber ‚Äî ‚ÄúLet us not look back in anger.‚Äù", "Pete Hegseth ‚Äî ‚ÄúStrength is built through challenge.‚Äù", "Anh Do ‚Äî ‚ÄúNever give up on your dreams.‚Äù", "Martha Beck ‚Äî ‚ÄúIntegrity is the cure for unhappiness.‚Äù"];

    // --- DELETE LOGIC ---
    let pendingDel = null;
    window.delTask = (id) => {
      pendingDel = id;
      document.getElementById('modal-overlay').style.display = 'flex';
    };
    document.getElementById('confirm-no').onclick = () => {
      document.getElementById('modal-overlay').style.display = 'none';
      pendingDel = null;
    };
    document.getElementById('confirm-yes').onclick = async () => {
      if(pendingDel) {
        await supabase.from('todolist').delete().eq('id', pendingDel);
        document.getElementById('modal-overlay').style.display = 'none';
        pendingDel = null;
        loadTasks();
      }
    };

    // --- DRAG & RESIZE ENGINE ---
    let activeWin = null, isDragging = false, isResizing = false;
    let startX, startY, startW, startH, startL, startT;

    document.addEventListener('mousedown', e => {
      const win = e.target.closest('.window');
      if (!win || e.target.classList.contains('close-btn')) return;
      activeWin = win;
      document.querySelectorAll('.window').forEach(w => w.style.zIndex = 1);
      win.style.zIndex = 10;
      startX = e.clientX; startY = e.clientY;
      startL = win.offsetLeft; startT = win.offsetTop;
      startW = win.offsetWidth; startH = win.offsetHeight;
      if (e.target.classList.contains('resize-handle')) isResizing = true;
      else if (e.target.closest('.window-header')) isDragging = true;
      else activeWin = null;
    });

    window.addEventListener('mousemove', e => {
      if (!activeWin) return;
      if (isResizing) {
        activeWin.style.width = Math.max(200, startW + (e.clientX - startX)) + 'px';
        activeWin.style.height = Math.max(120, startH + (e.clientY - startY)) + 'px';
      } else if (isDragging) {
        activeWin.style.left = (startL + (e.clientX - startX)) + 'px';
        activeWin.style.top = (startT + (e.clientY - startY)) + 'px';
      }
    });

    window.addEventListener('mouseup', () => { if(activeWin) saveLayout(); activeWin = null; isDragging = false; isResizing = false; });

    // --- TASKS & FILTERING ---
    window.loadTasks = async () => {
      const filterVal = document.getElementById('task-filter').value;
      const { data } = await supabase.from('todolist').select('*').eq('username', user).order('created_at', {ascending: false});
      
      const ids = { 'Urgent': '#list-urgent', 'This week': '#list-week', 'This month': '#list-month', 'Anytime': '#list-anytime' };
      document.querySelectorAll('table tbody').forEach(b => b.innerHTML = "");
      let counts = { Urgent:0, "This week":0, "This month":0, Anytime:0 };

      data?.forEach(t => {
        const row = `<tr><td><b>${t.uzd}</b><span class="time-text">${timeAgo(t.created_at)}</span></td><td style="text-align:right"><button onclick="delTask('${t.id}')" style="background:none; border:none; color:white; cursor:pointer;">‚úñ</button></td></tr>`;
        
        if (filterVal === "All" || t.uzdveids === filterVal) {
          document.querySelector("#list-all tbody").innerHTML += row;
        }
        if(ids[t.svarigums]) { 
          document.querySelector(ids[t.svarigums] + " tbody").innerHTML += row; 
          counts[t.svarigums]++; 
        }
      });
      updateChart(counts);
    };

    // --- OTHER DASHBOARD LOGIC ---
    window.closeWin = (id) => { document.getElementById(id).style.display = 'none'; saveLayout(); };
    window.toggleManager = () => {
      const m = document.getElementById('win-manager');
      m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
      m.innerHTML = '<b>Windows</b>';
      document.querySelectorAll('.window').forEach(w => {
        const btn = document.createElement('button');
        btn.className = 'win-toggle';
        btn.innerText = (w.style.display === 'none' ? 'Show ' : 'Hide ') + w.querySelector('span').innerText;
        btn.onclick = () => { w.style.display = (w.style.display === 'none' ? 'flex' : 'none'); toggleManager(); saveLayout(); };
        m.appendChild(btn);
      });
    };

    async function saveLayout() {
      const layout = {};
      document.querySelectorAll('.window').forEach(w => {
        layout[w.id] = { top: w.style.top, left: w.style.left, width: w.style.width, height: w.style.height, display: w.style.display };
      });
      await supabase.from('users').update({ dashboard_layout: layout }).eq('username', user);
    }

    function timeAgo(d) {
      const s = Math.floor((new Date() - new Date(d)) / 1000);
      return s < 60 ? "now" : s < 3600 ? Math.floor(s/60) + "m ago" : s < 86400 ? Math.floor(s/3600) + "h ago" : Math.floor(s/86400) + "d ago";
    }

    function updateChart(counts) {
      const ctx = document.getElementById('priorityChart');
      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type: 'bar', data: { labels: Object.keys(counts), datasets: [{ data: Object.values(counts), backgroundColor: '#a53239', borderColor: 'white', borderWidth: 1 }] },
        options: { maintainAspectRatio: false, scales: { y: { ticks: { color: 'white' } }, x: { ticks: { color: 'white' } } }, plugins: { legend: { display: false } } }
      });
    }

    function runClock() {
      const n = new Date(); document.getElementById('digital-clock').innerText = n.toLocaleTimeString();
      const s = n.getSeconds()*6, m = n.getMinutes()*6, h = (n.getHours()%12)*30 + (m/12);
      document.getElementById('sec-hand').style.transform = `rotate(${s}deg)`;
      document.getElementById('min-hand').style.transform = `rotate(${m}deg)`;
      document.getElementById('hour-hand').style.transform = `rotate(${h}deg)`;
    }

    async function init() {
      const { data } = await supabase.from('users').select('dashboard_layout').eq('username', user).single();
      if (data?.dashboard_layout) {
        Object.keys(data.dashboard_layout).forEach(id => {
          const w = document.getElementById(id);
          if (w) Object.assign(w.style, data.dashboard_layout[id]);
        });
      }
      loadTasks(); setInterval(() => { const display = document.getElementById('quote-display'); if(display.innerText === "Loading...") handleQuotes(); }, 1000); handleQuotes(); setInterval(runClock, 1000); runClock();
    }
    init();
  </script>
</body>
</html>
