<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Free-Move Dashboard</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <button class="reset-btn" onclick="resetLayout()">↺ Reset Layout</button>

  <div id="dashboard-canvas">
    <div id="win-tasks" class="window" style="top: 10%; left: 5%; width: 350px; height: 450px;">
      <div class="window-header">My Tasks</div>
      <div class="window-content">
        <div class="scroll-area"><table id="task-list"><tbody></tbody></table></div>
        <button onclick="location.href='save.html'">+ Add Task</button>
      </div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-stats" class="window" style="top: 10%; left: 40%; width: 400px; height: 320px;">
      <div class="window-header">Priority Stats</div>
      <div class="window-content">
        <canvas id="priorityChart"></canvas>
      </div>
      <div class="resize-handle"></div>
    </div>

    <div id="win-clock" class="window" style="top: 45%; left: 40%; width: 280px; height: 350px;">
      <div class="window-header">Clock</div>
      <div class="window-content">
        <div id="digital-clock">00:00:00</div>
        <div class="analog-face" id="clock-face">
          <div class="hand hour" id="hour-hand"></div>
          <div class="hand min" id="min-hand"></div>
          <div class="hand sec" id="sec-hand"></div>
        </div>
      </div>
      <div class="resize-handle"></div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';
    const user = localStorage.getItem("username");

    // --- CLOCK NUMBERS ---
    const face = document.getElementById('clock-face');
    for (let i = 1; i <= 12; i++) {
      const num = document.createElement('div');
      num.className = 'number';
      num.style.transform = `rotate(${i * 30}deg)`;
      num.innerHTML = `<span style="display:inline-block; transform:rotate(-${i * 30}deg)">${i}</span>`;
      face.appendChild(num);
    }

    // --- MOVE & RESIZE LOGIC ---
    let activeWin = null, isResizing = false;
    let startX, startY, startW, startH, startTop, startLeft;

    document.addEventListener('mousedown', e => {
      const win = e.target.closest('.window');
      if (!win) return;

      activeWin = win;
      document.querySelectorAll('.window').forEach(w => w.style.zIndex = 1);
      win.style.zIndex = 10;

      if (e.target.classList.contains('resize-handle')) {
        isResizing = true;
        startW = win.offsetWidth;
        startH = win.offsetHeight;
      } else if (e.target.classList.contains('window-header')) {
        isResizing = false;
        startTop = win.offsetTop;
        startLeft = win.offsetLeft;
      } else {
        activeWin = null; return;
      }

      startX = e.clientX;
      startY = e.clientY;
      e.preventDefault();
    });

    document.addEventListener('mousemove', e => {
      if (!activeWin) return;
      if (isResizing) {
        activeWin.style.width = (startW + (e.clientX - startX)) + 'px';
        activeWin.style.height = (startH + (e.clientY - startY)) + 'px';
        if(window.myChart && activeWin.id === 'win-stats') window.myChart.resize();
      } else {
        activeWin.style.top = (startTop + (e.clientY - startY)) + 'px';
        activeWin.style.left = (startLeft + (e.clientX - startX)) + 'px';
      }
    });

    document.addEventListener('mouseup', async () => {
      if (!activeWin) return;
      const layout = {};
      document.querySelectorAll('.window').forEach(win => {
        layout[win.id] = { 
          top: win.style.top, left: win.style.left, 
          width: win.style.width, height: win.style.height 
        };
      });
      await supabase.from('users').update({ dashboard_layout: layout }).eq('username', user);
      activeWin = null;
    });

    window.resetLayout = async () => {
      await supabase.from('users').update({ dashboard_layout: null }).eq('username', user);
      location.reload();
    };

    // --- DATA & INIT ---
    async function init() {
      const { data } = await supabase.from('users').select('dashboard_layout').eq('username', user).single();
      if (data?.dashboard_layout) {
        Object.keys(data.dashboard_layout).forEach(id => {
          const win = document.getElementById(id);
          if (win) Object.assign(win.style, data.dashboard_layout[id]);
        });
      }
      loadTasks();
    }

    async function loadTasks() {
      const { data } = await supabase.from('todolist').select('*').eq('username', user);
      const tbody = document.querySelector("#task-list tbody");
      tbody.innerHTML = "";
      let counts = { Urgent: 0, "This week": 0, "This month": 0, Anytime: 0 };
      data?.forEach(t => {
        if(counts[t.svarigums] !== undefined) counts[t.svarigums]++;
        tbody.innerHTML += `<tr><td>${t.uzd}</td><td style="text-align:right"><button onclick="delTask('${t.id}')">✖</button></td></tr>`;
      });
      updateChart(counts);
    }

    window.delTask = async (id) => {
      await supabase.from('todolist').delete().eq('id', id);
      loadTasks();
    };

    function updateChart(counts) {
      const ctx = document.getElementById('priorityChart');
      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(counts),
          datasets: [{ data: Object.values(counts), backgroundColor: '#792429', borderColor: 'white', borderWidth: 1 }]
        },
        options: { 
          maintainAspectRatio: false, 
          scales: { 
            y: { beginAtZero: true, ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
            x: { ticks: { color: 'white' }, grid: { display: false } }
          },
          plugins: { legend: { display: false } }
        }
      });
    }

    function runClock() {
      const now = new Date();
      document.getElementById('digital-clock').innerText = now.toLocaleTimeString();
      const s = now.getSeconds(), m = now.getMinutes(), h = now.getHours();
      document.getElementById('sec-hand').style.transform = `rotate(${s * 6}deg)`;
      document.getElementById('min-hand').style.transform = `rotate(${m * 6}deg)`;
      document.getElementById('hour-hand').style.transform = `rotate(${(h % 12) * 30 + (m / 2)}deg)`;
    }

    setInterval(runClock, 1000);
    runClock();
    init();
  </script>
</body>
</html>
